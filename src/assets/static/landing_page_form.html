<!doctype html>
<html>

<head>
  <title>Growth99+</title>

  <!-- <base href="/" /> -->

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="cache-control" content="no-cache" />

  <link rel="icon" type="image/x-icon" href="https://g99plus.b-cdn.net/AEMR/assets/img/growth99_icon.png" />

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }

    #formWrapper {
      padding: 20px;
    }

    .app-row {
      margin: 15px 0 0 0;
    }

    .app-row .label {
      display: block;
      margin: 0 0 5px;
    }

    .error-box {
      color: red !important;
    }

    .app-row button {
      position: relative;
      z-index: 9999999;
    }

    input,
    textarea,
    select {
      display: block;
      width: calc(100% - 1.8rem);
      padding: .375rem .75rem;
      font-size: 1rem;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      /* border: 1px solid #ced4da; */
      border-radius: .25rem;
      transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
      outline: 0;
    }

    input:focus,
    textarea:focus,
    select:focus {
      text-decoration: none;
      outline: 0;
      /*border: 0px;*/
      border: none !important;
    }

    input[type="checkbox"]:focus {
      box-shadow: none !important;
      outline: 0 !important;
    }

    .btn-submit {
      background-color: rgb(0, 59, 111);
      border: rgb(0, 59, 111);
      color: rgb(255, 255, 255);
      border-radius: 30px;
      height: 45px;
      padding: 0 30px;
      cursor: pointer;
      outline: 0;
    }

    .required {
      color: red;
    }

    .overlay {
      display: none;
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 999;
      background: rgba(255, 255, 255, 0.8);
      /*  url("loader.gif") center no-repeat */
    }

    /* Turn off scrollbar when body element has the loading class */

    .app-row .error-msg {
      color: red;
    }

    body.loading {
      overflow: hidden;
    }

    /* Make spinner image visible when body element has the loading class */

    body.loading .overlay {
      display: block;
      display: block;
      z-index: 99999999999999;
      opacity: 1;
      background: #fff;
    }


    .date {
      background-image: url(https://g99plus.b-cdn.net/AA%20new%20g99%20app/icons/calendar-custom.svg);
      background-repeat: no-repeat;
      background-position: right;
      background-position-x: 99%;
      box-shadow: none !important;
      border: 1px solid;
    }

    .input,
    textarea {
      border: 1px solid
    }

    .consent-form {
      margin-top: 15px;
      margin-bottom: 15px;
    }


    .dropdown select {
      width: calc(100% - 0.3rem);
      border: 1px solid;
      padding-left: 8px;
    }

    img#preview {
      max-width: 80%;
      display: block;
      padding: 1em;
    }

    .img-wrapper {
      position: relative;
    }

    #clearBtn {
      display: block;
      top: 1em;
      right: 2em;
      border: 2px solid black;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      background: #fff;
      font-weight: 700;
    }

    @media screen and (max-width:550px) {
      #ui-datepicker-div {
        margin-left: 0 !important;
      }
    }

    input.radio {
      display: inline-block;
      max-width: 15px;
    }

    #thankyou {
      display: none;
      padding: 100px 0;
    }

    .grecaptcha-badge {
      visibility: hidden;
    }

    .app-row.form-button {
      display: flex;
      justify-content: center;
    }

    .color-black {
      color: black !important;
    }

    /* <!-- ---------------------------- fileloadercss ---------------------------- --> */
    .loader {
      border: 10px solid #f3f3f3;
      border-top: 9px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      /* position: absolute; */
      right: 0;
      top: -41px;
    }

    .preview {
      max-width: 100%;
      padding: 1em;
      width: 300px;
    }

    .preview * {
      max-width: 100%;
    }


    #clearBtn {
      cursor: pointer;
    }

    .placeholder-color {
      color: #757575 !important;
      /* Adjust the color as needed */
    }

    .placeholder-color option {
      color: #495057 !important
        /* Adjust the color as needed */
    }

    .iti {
      width: 100%;
    }

    .iti input.phone-input {
      width: calc(100% - 0.2rem) !important;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media screen and (max-width:550px) {
      #ui-datepicker-div {
        margin-left: 0 !important;
      }
    }
  </style>
</head>

<body class="loading">

  <div id="formWrapper"></div>
  <div class="overlay">
    <p style="margin-top: 100px; margin-left: 45%;">Processing...</p>
  </div>


  <div id="thankyou">
    <div class="thanks">

      <div class="thanks-content">
        <div style="text-align:center;">
          <h1 style="text-align: center;">Thank You!</h1>
          <p style="text-align: center;">Your form has been submitted successfully.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

  <script>
    var questionarieDataFromAPI = {};
    var bid, fid, redirect = true,
      redirectUrl, trackingCode, lpid, lpname, divlist = [],
      questions;
    var buttoncss;
    var thankyouPageredirect = false
    var trackkingUrlonFormSubmit = sessionStorage.getItem("formTrackingUrl")
    var displayIdsLoadingIndicator = []
    var isMandatoryConsentEnabled = false;
    var isMandatoryConsentEnabledChecked = false;
    var mandatoryConsentText = '';
    let phoneNumberMap = {};
    // Below code is for trackking the url of form from where it is being submitted
    // =============================================================================
    console.log(window.addEventListener)
    if (window.addEventListener) {
      window.addEventListener("message", handleMessage);
    } else {
      window.attachEvent("onmessage", handleMessage);
    }

    function handleMessage(e) {
      console.log(e)
      if (e && e.data.startsWith("http")) {
        console.log(e.data)
        trackkingUrlonFormSubmit = e.data
        sessionStorage.setItem("formTrackingUrl", trackkingUrlonFormSubmit)
      }
    }
    // ==============================================================================
    $(function () {
      let thankYouPageUrl = null;
      var url = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');
      var variables = getUrlVars();
      bid = variables['bid'];
      fid = variables['fid'];
      lpid = variables['lpid'];
      globalFgColor = variables["color"]
      globalBgColor = variables["bgColor"];
      console.log(variables);
      if (!lpid) {
        var variables1 = getBrowserUrlVariables(document.referrer);
        lpid = variables1['lpid'];
      }
      console.log("businessId - " + bid + ", landingPageId - " + lpid + ", formId - " + fid);
      redirectUrl = url + "/thankyou?bid=" + bid;
      getBusiness(); // variables['bid'], variables['fid']

      try {
        if ('redirect' in variables) {
          if (variables['redirect'] === 'true') {
            if ('redirectUrl' in variables) {
              redirectUrl = variables['redirectUrl'];
              redirect = true;
            }
          }
        }
      } catch ($e) {
        console.log("catch", $e);
      }
    });

    function getUrlVars() {
      var vars = [],
        hash;
      var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
      for (var i = 0; i < hashes.length; i++) {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
      }
      return vars;
    }

    function getBrowserUrlVariables(url) {
      var vars = [],
        hash;
      var hashes = url.slice(url.indexOf('?') + 1).split('&');
      for (var i = 0; i < hashes.length; i++) {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
      }
      return vars;
    }

    function getBusiness() {
      $.ajax({
        url: getApiUrl() + "/api/public/v1/businesses/" + bid,
        method: 'GET',
        headers: {
          'X-TenantID': '' + bid
        },
        success: function (data, textStatus) {
          if (!data.deleted) {
            loadForm();
          } else {
            alert("The Business is disabled.");
          }
        }
      });
    }


    function loadForm() {
      $.ajax({
        url: getApiUrl() + "/api/public/questionnaire/" + fid,
        method: 'GET',
        headers: {
          'X-TenantID': '' + bid
        },
        success: function (data, textStatus) {
          questionarieDataFromAPI = data
          thankYouPageUrl = data?.thankYouPageUrl
          createForm(data);
        }
      });

      if (lpid) {
        $.ajax({
          url: getApiUrl() + "/api/public/landingpage/" + lpid,
          method: 'GET',
          headers: {
            'X-TenantID': '' + bid
          },
          success: function (data, textStatus) {
            // $("#landingPage").html(data.landingPageTemplate);
            // document.title = data.name;
            buttoncss = data.buttonCSS;
            lpname = data.name;

            if (buttoncss != null) {
              $('<style>').text(buttoncss).appendTo(document.head);
            }
            if (data.css && data.css != null) {
              $('<style>').text(data.css).appendTo(document.head);
             }

            if (data.googleAnalyticsGlobalCodeUrl != null && data.googleAnalyticsGlobalCodeUrl != '') {
              var s = document.createElement('script');
              s.src = data.googleAnalyticsGlobalCodeUrl;
              document.head.appendChild(s);

              if (data.googleAnalyticsGlobalCode != null && data.googleAnalyticsGlobalCode != '') {
                var str = data.googleAnalyticsGlobalCode;
                str = str.replace(/<script>/g, '');
                str = str.replace(/<\/script>/g, '');
                var s1 = document.createElement('script');
                s1.textContent = str;
                document.head.appendChild(s1);

                if (data.landingPageTrackCode != null && data.landingPageTrackCode != '') {
                  var str1 = data.landingPageTrackCode;
                  str1 = str1.replace(/<script>/g, '');
                  str1 = str1.replace(/<\/script>/g, '');
                  trackingCode = str1;

                }
              }
            }

          }
        });
      }
    }

    function createForm(data) {
      var captcha = document.createElement('script');
      captcha.setAttribute('src', 'https://www.google.com/recaptcha/api.js?render=' + gcaptchaKey);
      document.head.appendChild(captcha);

      if (data.thankYouPageUrl) {
        thankyouPageredirect = true;
        redirect = true;
        redirectUrl = data.thankYouPageUrl;
      }
      if (data.thankYouPageUrlLandingPage) {
        thankyouPageredirect = true;
        redirect = true;
        redirectUrl = data.thankYouPageUrlLandingPage;
      }
      var titleColor = "inherit";
      if (data.titleColor != null) {
        titleColor = data.titleColor;
      }
      var showTitle = true;
      if (data.showTitle != null) {
        showTitle = data.showTitle;
      }

      var hideFieldTitle = false;
      if (data.hideFieldTitle && data.hideFieldTitle != null) {
        hideFieldTitle = data.hideFieldTitle;
      }

      isMandatoryConsentEnabled = data?.consentLeadForm;
      mandatoryConsentText = data?.consentLeadTextForm;


      var disp = (showTitle) ? 'block' : 'none';
      var style = " style='margin: 0 0 15px;font-weight:normal;color:" + titleColor + ";display:" + disp + "' ";

      $("#formWrapper")
        .append('<h3' + style + '>' + data.questionnaireName + '<h3>')
        .append('<form action="#" method="POST" id="formId" class="frm">');
      questions = data.patientQuestionAnswers;
      var patientQuestionAnswers = data.patientQuestionAnswers;
      for (var i = 0; i < patientQuestionAnswers.length; i++) {
        var question = patientQuestionAnswers[i];
        createInputElement(question, data, hideFieldTitle);
      }

      if (isMandatoryConsentEnabled) {
        $("#formId").append(" <div class='checkbox consent-form'> <div><input type='checkbox' onchange = validateConsentCheckBox(this) class='pre-checked-input' style='display:inline-block; max-width: 20px;'/> <label>" + mandatoryConsentText + " <span style='color: red;>*</span></label></div>");
        $("#formId").append("<div class='checkbox-consent-mendatory-form' style='display:none;color: red;margin-top: 7px;font-size: 12px;'>Please select the consent to continue</div></div>");
      }

      // $("#formId").append("<div class='app-row'><div class='g-recaptcha' data-sitekey='"+ gcaptchaKey+"'></div></div>");
      createButton(data);

      var inputBoxShadowColor = "#003B6F";
      if (data.inputBoxShadowColor != null) {
        inputBoxShadowColor = data.inputBoxShadowColor;
      }
      setTimeout(() => {
        $("body").removeClass("loading");
      }, 1500)

      $("#formId input, #formId textarea, #formId select").focusin(function () {
        $(this).css('box-shadow', " 0 0 0 0.05rem " + inputBoxShadowColor);
      }).focusout(function () {
        $(this).css('box-shadow', " 0 0 0 0rem " + inputBoxShadowColor);
      });
      $("#formId").submit(function (event) {
        event.preventDefault();
        let hasPhoneError = false;
        hasCheckboxError = false;
        requiredCheckBoxCount = 0
        if ($('.checkbox').length) {
          for (var i = 0; i < questions.length; i++) {
            console.log($('.checkbox :checkbox:checked').length)
            if (questions[i].questionType === "Multiple_Selection_Text" && questions[i].required === true && !questions[i].showDropDown && (questions[i].allowMultipleSelection || questions[i].preSelectCheckbox)) {
              requiredCheckBoxCount = requiredCheckBoxCount + 1
              if ($('.checkbox :checkbox[name="' + questions[i].questionId + '"]:checked').length === 0) {
                console.log($('.checkbox' + questions[i].questionId))
                $('.checkbox' + questions[i].questionId).css("display", "block")
                hasCheckboxError = true;
                // console.log($('.checkbox' + questions[i].questionId).offset().top)
                // $('html, body').animate({
                //   scrollTop: $('.checkbox' + questions[i].questionId).offset().top
                // }, 200);
                // return false


              }
              else {
                $('.checkbox' + questions[i].questionId).css("display", "none")
              }
            } else if (questions[i].questionType === "Phone_Number") {
              const question = questions[i];
              if ((question.required || $("#q_" + question.questionId).val()) && !phoneNumberMap[question.questionId].isValidNumber()) {
                $('#v_' + question.questionId).css("display", "block");
                hasPhoneError = true;
              } else {
                $('#v_' + question.questionId).css("display", "none");
              }
            }
          }

          if (isMandatoryConsentEnabled && !isMandatoryConsentEnabledChecked) {
            $('.checkbox-consent-mendatory-form').css("display", "block")
            hasCheckboxError = true;
          }
          else {
            $('.checkbox-consent-mendatory-form').css("display", "none")
          }
        }

        if (hasCheckboxError || hasPhoneError) {
          event.preventDefault();
          return;
        }

        $('.app-row.abc button').addClass("disabled");
        $('.app-row.abc button').attr("disabled", true);

        setTimeout(() => {
          $('.app-row.abc button').removeClass("disabled");
          $('.app-row.abc button').attr("disabled", false);
        }, 2000)
        for (var i = 0; i < divlist.length; i++) {
          document.getElementById(divlist[i]).style.display = "none";
        }


        var flag = false;
        for (var i = 0; i < questions.length; i++) {
          if (questions[i].questionType != "Yes_No" &&
            questions[i].questionType != "Multiple_Selection_Text" &&
            questions[i].questionType != "Date" &&
            questions[i].validationMessage != null &&
            questions[i].validate &&
            (questions[i].hidden === null || questions[i].hidden === false)) {
            console.log(questions[i]);
            divlist.push("v_" + questions[i].questionId);
            console.log(document.getElementById("q_" + questions[i].questionId).value);
            var x = document.getElementById("q_" + questions[i].questionId).value;
            var regex = questions[i].regex;
            console.log(regex);
            if (regex != null && !x.match(regex) && regex != 'Other') {
              console.log(document.getElementById("q_" + questions[i].questionId).value); // alert(questions[i].questionName + " is not valid");
              // alert(questions[i].validationMessage );
              if (questions[i].validationMessage != null)
                document.getElementById("v_" + questions[i].questionId).style.display = "block";
              // event.preventDefault();
              flag = true;
              // return false;
            }
          }

        }

        let imageLoading = false;
        displayIdsLoadingIndicator.forEach(data => {
          if (document.getElementById(data).style.display === 'block') {
            imageLoading = true;
            flag = true;
          }
        })

        if (imageLoading) {
          alert("File uploading is under progress and please submit once after the file is uploaded");
        }



        if (flag) {
          return false;
        }
        var captcharesponse = "";

        grecaptcha.ready(function () {
          grecaptcha.execute(gcaptchaKey, {
            action: 'submit'
          }).then(function (token) {
            captcharesponse = token;
          });
        });

        $("body").addClass("loading");
        var formData = $("#formId").serializeArray();
        var keys = Object.keys(formData);
        var patientQuestionAnswers = [];
        let formQuestionData;


        //  <!-- ----------------------------------------------------------------------- -->
        //  <!--                    Below if else needs to be fixed X                    -->
        //  <!-- ----------------------------------------------------------------------- -->
        if (questionarieDataFromAPI && questionarieDataFromAPI?.patientQuestionAnswers) {
          formQuestionData = questionarieDataFromAPI?.patientQuestionAnswers
        }
        else {
          formQuestionData = questionarieDataFromAPI
        }

        let mappedData = formQuestionData.map(question => {

          var _value = "";
          // if (fc) {
          //   if (question != null) {
          //     var preFillData = questionHasPreFillData(question);
          //     if (preFillData != null) {
          //       _value = preFillData;
          //       question.answerText = _value;
          //       console.log(question)
          //       return question;
          //     }
          //   }
          // }
          let updatedformData = formData.filter(data => data.name === question.questionId.toString());
          if (updatedformData.length > 0) {
            question.answerText = updatedformData.map(data => data.value).join(",");
          }
          if (question.questionType === 'Phone_Number' && phoneNumberMap[question.questionId].isValidNumber()) {
            let phoneNumber = phoneNumberMap[question.questionId].getNumber(intlTelInputUtils.numberFormat.E164);
            const dialCode = phoneNumberMap[question.questionId].getSelectedCountryData().dialCode;
            phoneNumber = phoneNumber.substring(phoneNumber.indexOf(dialCode) + dialCode.length);
            question.answerText = phoneNumber;
          }
          return question;
        });

        console.log(mappedData);
        patientQuestionAnswers = mappedData;


        // keys.forEach(key => {
        //   patientQuestionAnswers.push({
        //     'questionId': formData[key].name,
        //     'answerText': formData[key].value,
        //     'questionType': $("#q_" + formData[key].name).attr("data-type")
        //   });
        //   // }
        // });

        setTimeout(
          function () {
            trackkingUrlonFormSubmit = sessionStorage.getItem("formTrackingUrl")
            console.log(trackkingUrlonFormSubmit)
            if (!trackkingUrlonFormSubmit) {
              trackkingUrlonFormSubmit = document.referrer
            }
            const modifiedUrl = trackkingUrlonFormSubmit.replace(/token=.*?(?=&|$)/, '');
            console.log(modifiedUrl);
            var formReq = {
              sourceUrl: modifiedUrl,
              source: "Landing Page",
              landingPageName: lpname,
              landingPageId: lpid,
              questionnaireId: fid,
              gcaptcharesponse: captcharesponse,
              patientQuestionAnswers: patientQuestionAnswers
            }

            $.ajax({
              url: getApiUrl() + '/api/public/questionnaire/' + fid,
              method: 'POST',
              data: JSON.stringify(formReq),
              contentType: 'application/json',
              headers: {
                'X-TenantID': '' + bid
              },
              success: function (response, statusText) {
                $('.app-row.abc button').removeClass("disabled");
                $('.app-row.abc button').attr("disabled", false);
                // alert("Form submitted successfully.");

                handleRedirectForThankYouPage()


                var s2 = document.createElement('script');
                s2.textContent = trackingCode;
                document.head.appendChild(s2);
                $("body").removeClass("loading");

              },
              error: function (error) {
                $('.app-row.abc button').removeClass("disabled");
                $('.app-row.abc button').attr("disabled", false);
                $("body").removeClass("loading");
                alert("Unable to submit form. Please try again later.");
              }
            })
          }, 2000);

      });
    }

    function validateConsentCheckBox(input) {
      isMandatoryConsentEnabledChecked = input.checked;
    }

    // below function is for how we want to handle redirect
    function handleRedirectForThankYouPage() {
      console.log("thank", thankYouPageUrl);
      if (thankyouPageredirect) {
        try {
          if (document.referrer.includes("landingpage.html") || document.referrer.includes("landingpage.html")) {
            //If form is submited from Symptom composer it should not reload page
            // it should show thank you page inside iframe without refresh
            console.log("========================composer")
            window.location = redirectUrl

            //   ================  End of if condition ============================ //
          } else {
            if (form_iniFrame()) {
              console.log("In if of form_iniFrame");
              window.top.location.href = redirectUrl;
            } else {
              console.log("In else of form_iniFrame");
              window.top.location.href = redirectUrl;
            }
          }

        } catch (e) {
          console.log("In redirect exception")
          window.top.location.href = redirectUrl;
        }
      }
      else {
        document.getElementById("formId").style.display = "none";
        document.getElementById("thankyou").style.display = "block";
      }
    }

    function handleRedirect() {
      if (redirect) {
        if (form_iniFrame()) {
          var myEvent = new CustomEvent('gplus_custom_event', {
            detail: {
              url: redirectUrl,
              type: 'redirect'
            }
          });
          window.parent.dispatchEvent(myEvent)
        } else {
          window.top.location = redirectUrl;
        }
      }
    }

    function createButton(data) {
      var buttonBackgroundColor = "#003B6F";
      var buttonForegroundColor = "#FFF";
      let params = decodeURI(window.location.href)
        .replace('?', '')
        .split('&')
        .map(param => param.split('='))
        .reduce((values, [key, value]) => {
          values[key] = value
          return values
        }, {})
      console.log(params)

      // if (data.buttonBackgroundColor != null) {
      //     buttonBackgroundColor = data.buttonBackgroundColor;
      // }

      // if (data.buttonForegroundColor != null) {
      //     buttonForegroundColor = data.buttonForegroundColor;
      // }

      if (params.color) {
        buttonForegroundColor = params.color.trim()
      }
      if (params.bgColor) {
        buttonBackgroundColor = params.bgColor.trim()
        setTimeout(() => {
          $(".app-row.abc button").css("background-color", buttonBackgroundColor)
          $(".app-row.abc button").css("color", buttonForegroundColor)
        }, 1000)
      } else {
        setTimeout(() => {
          buttonBackgroundColor = sessionStorage.getItem("lpbgColor")
          buttonForegroundColor = sessionStorage.getItem("lpfgColor")
          console.log("buttonBackgroundColor", buttonBackgroundColor)
          $(".app-row.abc button").css("background-color", buttonBackgroundColor)
          $(".app-row.abc button").css("color", buttonForegroundColor)
        }, 1000)
      }

      console.log(buttonBackgroundColor)
      var style = "background:" + buttonBackgroundColor + "; color:" + buttonForegroundColor;
      // style='" + style + "'
      $("#formId").append("<div class='app-row abc form-button'>" +
        "<button type='submit' class='button'>Submit</button>" +
        "</div>");
    }

    function createInputElement(question, data, hideFieldTitle) {

      var req = "";
      var reqLabel = "";
      if (question.required) {
        req = "required='true'";
        reqLabel = "<span class='required'>*</span>";
      }

      date_format = 'mm/dd/yy'
      if (question.questionType === "Date") {
        console.log("In question Type");
        if (question.regex === '^(0?[1-9]|[12][0-9]|3[01])[-\/](0?[1-9]|1[012])[-\/]((?:19|20|21)[0-9][0-9])$') {
          date_format = 'dd/mm/yy'
        } else if (question.regex === '^(0?[1-9]|1[012])[-\/](0?[1-9]|[12][0-9]|3[01])[-\/]((?:19|20|21)[0-9][0-9])$') {
          date_format = 'mm/dd/yy'
        } else if (question.regex === '^((?:19|20|21)[0-9][0-9])[-\/](0?[1-9]|1[012])[-\/](0?[1-9]|[12][0-9]|3[01])$') {
          date_format = 'yy/mm/dd'
        }
      }

      var hiddenFieldTitleText = "";
      if (!hideFieldTitle) {
        hiddenFieldTitleText = " style='display:none' ";
      }


      // hidden
      var hidden = "";
      if (question.hidden != null && question.hidden === true) {
        hidden = " style='display:none' "
      }

      var inputBoxShadowColor = "#003B6F";
      if (data.inputBoxShadowColor != null) {
        inputBoxShadowColor = data.inputBoxShadowColor;
      }
      var inputStyle = ""; // " style='box-shadow: 0 0 0 0.05rem " + inputBoxShadowColor + "' ";

      if (question.questionType === "Input") {
        const emailArray = ['email', 'email id', 'email address']
        let placeholder = question.questionName
        console.log(question.questionName.toLowerCase(), question.questionName.toLowerCase().includes(emailArray))
        if (question.questionName && emailArray.includes(question.questionName.toLowerCase())) {
          placeholder = 'Email Address'
        }
        // var h =
        //     "<div class='app-row' " + hidden + ">" +
        //     "<label class='label' " + hiddenFieldTitleText + ">" + question.questionName + reqLabel + "</label>" +
        //     "<div>" +
        //     "<input " + inputStyle + " type='text' class='input input-border' data-type='" + question.questionType + "' id='q_" + question.questionId + "' name='" + question.questionId + "' placeholder='" + question.questionName + "' " + req + " />" +
        //     "</div>" +
        //     "<div style='display:none;color: red;margin-top: 7px;' id='v_" + question.questionId + "' >" +
        //     "<span class='has-error'>" + question.validationMessage + "</span>" +
        //     "</div>" +
        //     "</div>";
        // $("#formId").append(h);

        var h =
          "<div class='app-row' " + hidden + ">" +
          "<label class='label' " + hiddenFieldTitleText + ">" + placeholder + reqLabel + "</label>" +
          "<div>" +
          "<input   " + inputStyle + " type='text' class='input input-border' data-type='" + question.questionType + "' id='q_" +
          question.questionId + "' name='" + question.questionId + "' placeholder='" + placeholder + "' " + req +
          " oninput='validateForm()'/>" +
          "</div>" +
          "<div style='display:none;color: red;margin-top: 7px;font-size: 12px;' id='v_" + question.questionId + "' >" +
          "<span class='error-msg'>" + question.validationMessage + "</span>" +
          "</div>" +
          "</div>";
        $("#formId").append(h);

      }

      else if (question.questionType === "File") {

        var h =
          "<div class='app-row type-input' " + hidden + ">" +
          "<label class='label' " + hiddenFieldTitleText + ">" + question.questionName + reqLabel + "</label>" +
          "<div class='input-field'>" +
          "<input id='fileInput'  " + inputStyle + " type='file' class='input input-border fileInput_" + question.questionId + "' data-type='" + question.questionType + "' data-type1='" + question.questionName + "' id='q_" +
          question.questionId + "' name='" + question.questionId + "' placeholder='" + question.questionName + "' " + req +
          "onchange='previewImage(this)' accept='image/jpeg,image/png,image/gif,.pdf,.xls,.xlsx'/>" +
          "</div>" +
          "<div style='display:none;color: red;margin-top: 7px;font-size: 12px;' id='v_" + question.questionId + "' >" +
          "<span>" + question.validationMessage + "</span>" +
          "</div>" +
          "</div>" +
          `
          <div id="clearBtn" class="clearBtn_${question.questionId}" onclick="clearPreview(${question.questionId})" style="display: none; margin-top : 10px; cursor: pointer; text-align: center"><div style="margin-top:5px">X</div></div>
          <div class="preview preview_${question.questionId}"></div>
            <div id="fileInputLoader_${question.questionId}" style="display:none;">
  <div class="loader"></div>
</div>
          </div>`;
        $("#formId").append(h);

      }

      else if (question.questionType === "Text") {

        // var h =
        //     "<div class='app-row' " + hidden + ">" +
        //     "<label class='label'" + hiddenFieldTitleText + ">" + question.questionName + reqLabel + "</label>" +
        //     "<div>" +
        //     "<textarea " + inputStyle + " data-type='" + question.questionType + "' id='q_" + question.questionId + "' name='" + question.questionId + "' placeholder='" + question.questionName + "' " + req + "></textarea>" +
        //     "</div>" +
        //     "<div style='display:none;color: red;margin-top: 7px;' id='v_" + question.questionId + "' >" +
        //     "<span class='has-error'>" + question.validationMessage + "</span>" +
        //     "</div>" +
        //     "</div>";
        // $("#formId").append(h);

        var h =
          "<div class='app-row' " + hidden + ">" +
          "<label class='label'" + hiddenFieldTitleText + ">" + question.questionName + reqLabel + "</label>" +
          "<div>" +
          "<textarea " + inputStyle + " data-type='" + question.questionType + "' id='q_" + question.questionId + "' name='" + question.questionId + "' placeholder='" + question.questionName + "' " + req + "></textarea>" +
          "</div>" +
          "<div style='display:none;color: red;margin-top: 7px;font-size: 12px;' id='v_" + question.questionId + "' >" +
          "<span class='error-msg'>" + question.validationMessage + "</span>" +
          "</div>" +
          "</div>";
        $("#formId").append(h);

      } else if (question.questionType === "Yes_No") {
        var bgColor = $(".app-row button").css("background-color");
        console.log("bgColor=========", bgColor)
        if (!bgColor) {
          bgColor = localStorage.getItem("formbuttonColor")
        }
        // var h =
        //     "<div class='app-row' " + hidden + ">" +
        //     "<label class='label'>" + question.questionName + reqLabel + "</label>" +
        //     "<div class='textraido' style='color:" + bgColor + "'>" +
        //     "<input type='radio' value='Yes' class='radio' " + inputStyle + " data-type='" + question.questionType + "' id='q_" + question.questionId + "' name='" + question.questionId + "' " + req + "> Yes" +
        //     "&nbsp;&nbsp;<input type='radio' value='No' class='radio' " + inputStyle + " data-type='" + question.questionType + "' id='q_" + question.questionId + "' name='" + question.questionId + "'> No" +
        //     "</div>" +
        //     "<div style='display:none;color: red;margin-top: 7px;' id='v_" + question.questionId + "' >" +
        //     "<span class='has-error'>" + question.validationMessage + "</span>" +
        //     "</div>" +
        //     "</div>";
        // $("#formId").append(h);

        var h =
          "<div class='app-row' " + hidden + ">" +
          "<label class='label'>" + question.questionName + reqLabel + "</label>" +
          "<div>" +
          "<input onchange= 'validateRadio(this)' ' data-type1='" + question.questionName + "' type='radio' value='Yes' class='radio'  " + inputStyle + " data-type='" + question.questionType + "' id='q_" + question.questionId + "' name='" + question.questionId + "' " + req + "> Yes" +
          "&nbsp;&nbsp;<input onchange= 'validateRadio(this)' type='radio' value='No' class='radio' " + inputStyle + " data-type='" + question.questionType + "' id='q_" + question.questionId + "' name='" + question.questionId + "'> No" +
          "</div>" +
          "<div style='display:none;color: red;margin-top: 7px;font-size: 12px;' id='v_" + question.questionId + "' >" +
          "<span class='error-msg'>" + question.validationMessage + "</span>" +
          "</div>" +
          "</div>";
        $("#formId").append(h);

      }
      else if (question.questionType === "Date") {
        var h =
          "<div class='app-row type-boolean' " + hidden + ">" +
          "<label class='label'>" + question.questionName + reqLabel + "</label>" +
          "<div style='position:relative'>" +
          "<input type='text'  onblur = 'getProductqty(this)' class='date' autocomplete='off' onkeydown='return false;'  " + inputStyle + " data-type='" + question.questionType + "' data-type1='" + question.questionName + "' id='q_" + question.questionId + "' name='" + question.questionId + "' " + req +
          "oninput='validateForm()' />" +
          "</div>" +
          "<div style='display:none;color: red;margin-top: 7px;font-size: 12px;' id='v_" + question.questionId + "' >" +
          "<span>" + question.validationMessage + "</span>" +
          "</div>" +
          "</div>";
        $("#formId").append(h);
        $(".date").datepicker({
          changeYear: true,
          dateFormat: date_format,
          yearRange: '1940:2030',
          beforeShow: function (textbox, instance) {
            instance.dpDiv.css({
              marginTop: (-textbox.offsetHeight) + 'px',
              marginLeft: '130px',
            });
          }
        });

      }
      else if (question.questionType === "Multiple_Selection_Text") {
        let prechecked = false
        let element = ""
        let precheckedClass = ""
        var qt = (question.allowMultipleSelection) ? "checkbox" : "radio";
        if (!question.allowMultipleSelection && question.showDropDown) {
          qt = "dropdown"
        }
        if (!question.showDropDown && question.preSelectCheckbox) {
          qt = "checkbox"
          prechecked = true
          element = "checked" + " class='pre-checked-input'"
          precheckedClass = "pre-checked-label"
        }
        var h =
          "<div class='app-row type-multi  " + precheckedClass + "'" + hidden + ">" +
          "<label>" + question.questionName + reqLabel + "</label>";

        if (qt === "radio") {
          for (var i = 0; i < question.patientQuestionChoices.length; i++) {
            question.patientQuestionChoices[i].choiceName = question.patientQuestionChoices[i].choiceName.replace("'", "&#39;");
            let qid = question.questionId + "_" + i;
            h += "<div class='radio'>" +
              "<input  onchange= 'validateRadio(this)'" + inputStyle + " type='" + qt + "' class=''  " +
              " data-type='" + question.questionType + "' data-type1='" + question.questionName + "' id='q_" + qid + "' name='" + question.questionId + "'" +
              " value='" + question.patientQuestionChoices[i].choiceName + "'" +
              "' placeholder='" + question.questionName + "' " + req +
              "' choiceId='" + question.patientQuestionChoices[i].choiceId + "' " +
              " style='display:inline-block; max-width: 20px;' />" +
              question.patientQuestionChoices[i].choiceName +
              "</div>";

          }
        }
        else if (qt === "checkbox") {
          h += "<div " + req + " class='color-black'>";
          for (var i = 0; i < question.patientQuestionChoices.length; i++) {
            question.patientQuestionChoices[i].choiceName = question.patientQuestionChoices[i].choiceName.replace("'", "&#39;");
            let qid = question.questionId + "_" + i;
            h += "<div class='checkbox color-black'>" +
              "<input  onchange= 'validateCheckBox(this)'" + inputStyle + " type='" + qt + "' " + element +
              " data-type='" + question.questionType + "' data-type1='" + question.questionName + "' id='q_" + qid + "' name='" + question.questionId + "'" +
              " value='" + question.patientQuestionChoices[i].choiceName + "'" +
              "' placeholder='" + question.questionName + "' " +
              "' choiceId='" + question.patientQuestionChoices[i].choiceId + "' " +
              " style='display:inline-block; max-width: 20px;' />" +
              question.patientQuestionChoices[i].choiceName +
              "</div>";
          }
          h += "<div class='error-checkbox error-box checkbox" + question.questionId + "' style='display:none;color: red !important;margin-top: 7px;font-size: 12px;' >Please select the option to continue</div>"
        }
        else if (qt === "dropdown") {
          var isRequired = question.required;
          h += "<div " + req + ">";
          h += "<div class='dropdown'><select class='placeholder-color' id='q_" + question.questionId + "' name='" + question.questionId + "'";

          // Add the 'required' attribute conditionally
          if (isRequired) {
            h += " required";
          }

          h += " onchange='handleDropdownChange(this)'>";
          h += "<option value='' disabled selected>" + question.questionName + "</option>"
          for (var i = 0; i < question.patientQuestionChoices.length; i++) {
            question.patientQuestionChoices[i].choiceName = question.patientQuestionChoices[i].choiceName.replace("'", "&#39;");
            let qid = question.questionId + "_" + i;
            h += "<option value='" + question.patientQuestionChoices[i].choiceName + "'>" +
              question.patientQuestionChoices[i].choiceName + "</option>"

          }
          h += "</select></div>";
        }


        h += "</div>";

        $("#formId").append(h);
        setTimeout(() => {
          var color = $(".app-row button").css("background-color");

          // BELOW CHECK IS DONE FOR POPUP VIEW ON PORTAL URL
          //IF LLABEL COLOR IS WHITE RENDER DEFAULT LABEL COLOR
          globalFgColor = decodeURI(globalFgColor)
          console.log("color==", color, decodeURI(globalFgColor))
          if (globalFgColor && (globalFgColor === "rgb(255, 255, 255)" || globalFgColor.startsWith("#fff"))) {
            //console.log("679 here")
          }
          else {
            //console.log("682 here")
            $(".app-row .label").css("color", color);
            $(".app-row div").css("color", color);
          }
        }, 1000)

      } else if (question.questionType === "Phone_Number") {
        const placeholder = 'Phone Number';
        const questionId = question.questionId;
        var h =
          "<div class='app-row type-input' " + hidden + ">" +
          "<label class='label' " + hiddenFieldTitleText + ">" + placeholder + reqLabel + "</label>" +
          "<div class='input-field'>" +
          "<input   " + inputStyle + " type='text' class='input input-border phone-input' data-type='" + question.questionType + "' data-type1='" + question.questionName + "' id='q_" +
          question.questionId + "' name='" + question.questionId + "' " + req +
          " oninput='validatePhoneNumber(this)'/>" +
          "</div>" +
          "<div style='display:none;color: red;margin-top: 7px;font-size: 12px;' id='v_" + question.questionId + "' >" +
          "<span>Invalid Phone Number.</span>" +
          "</div>" +
          "</div>";
        $("#formId").append(h);
        const input = document.querySelector("#q_" + questionId);
        const iti = window.intlTelInput(input, {
          formatOnDisplay: true,
          separateDialCode: true,
          utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
        });
        input.addEventListener('countrychange', function (e) {
          if (e.currentTarget.value) {
            $(e.currentTarget).trigger('input');
          }
        })
        phoneNumberMap[questionId] = iti;
      }
    }

    function getApiUrl() {
      var hostname = window.location.hostname;
      //const reCaptchaKey = "6Le4KZgcAAAAACzeRnurL7ZsHiI6lypvvfZL_Hu4";
      const reCaptchaKey = "6LfWEkwhAAAAAN6xg27w8u0MZZg0QCR_P_9LWj-_";
      if (hostname.includes("prod-app.growth99.com")) {
        gcaptchaKey = reCaptchaKey;
        return "https://api.growth99.com";
      } else if (hostname.includes("devemr.growthemr.com")) {
        gcaptchaKey = reCaptchaKey;
        return "https://api.growthemr.com";
      } else if (hostname.includes("localhost")) {
        gcaptchaKey = reCaptchaKey;
        return "https://api.growthemr.com";
        // return "http://localhost:8080";
      } else {
        gcaptchaKey = reCaptchaKey;
        return "https://api.growth99.com";
      }
    }

    function form_iniFrame() {
      if (window.self !== window.top) {
        return true;
      } else {
        return false;
      }
    }

    function validateForm() {
      for (var i = 0; i < divlist.length; i++) {
        //console.log(divlist[i]);
        document.getElementById(divlist[i]).style.display = "none";
      }

      divlist = [];
      for (var i = 0; i < questions.length; i++) {
        if (questions[i].questionType != "Yes_No" &&
          questions[i].questionType != "Multiple_Selection_Text" &&
          questions[i].questionType != "Date" &&
          questions[i].validationMessage != null &&
          questions[i].validate) {
          //console.log(questions[i]);
          divlist.push("v_" + questions[i].questionId);
          //console.log(document.getElementById("q_" + questions[i].questionId).value);
          var x = document.getElementById("q_" + questions[i].questionId).value;
          var regex = questions[i].regex;
          //console.log(regex);
          if (regex != null && !x.match(regex) && regex != 'Other' && x != '') {
            //console.log(document.getElementById("q_" + questions[i].questionId).value); // alert(questions[i].questionName + " is not valid");
            // alert(questions[i].validationMessage );
            if (questions[i].validationMessage != null)
              document.getElementById("v_" + questions[i].questionId).style.display = "block";
          }
        }
      }
    }

    function getProductqty(input) {
      setTimeout(() => {
        let qid = input.name
        let obj = questions.find(x => x.questionId === qid);

      }, 500)
    }

    function validateRadio(input, q) {
      let selected = input.checked;
      console.log(selected, input, q)
      const question_type = input.getAttribute("data-type");
      console.log(question_type);
      let qid = input.name
      let obj;
      if (question_type === 'Multiple_Selection_Text') {
        validateCheckBox(input);
      }

      else if (question_type === 'Yes_No') {
        questions.forEach(question => {
          if (question.questionId === qid) {
            obj = question
            obj.answerText = selected
          }
        });
      }
    }
    function validateCheckBox(input) {
      let choiceId = input.getAttribute("choiceid");
      let selected = input.checked;
      let qid = input.name
      let obj;
      questions.forEach(question => {
        if (question.questionId === qid) {
          obj = question
          question.patientQuestionChoices.forEach(choice => {
            if (choice.choiceId === choiceId) {
              choice.selected = selected;
            }
          });
        }
      });
      questionarieDataFromAPI = questions

      // let obj = questions.find(x => x.questionId === qid);
      if (obj.required) {
        if ($('.checkbox').length) {
          if ($('.checkbox :checkbox:checked').length === 0) {
            $('.error-checkbox.checkbox' + qid).css("display", "block")
            $('html, body').animate({
              scrollTop: $(".error-checkbox").offset().top
            }, 200);
            return false
          }
          else {
            $('.error-checkbox').css("display", "none")
          }
        }
      }

    }

    function previewImage(input) {

      acceptable_types = ["application/pdf", "application/vnd.ms-excel",
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        "application/vnd.openxmlformats-officedocument.wordprocessingml.document"]

      if (input.files.length < 1) {
        return;
      }

      var pattern = /image-*/;
      if (!input.files[0].type.match(pattern) && input.files[0].type != 'application/pdf' && !acceptable_types.includes(input.files[0].type)) {
        alert('Invalid format only supports images, pdf and excel');
        document.getElementsByClassName("fileInput_" + input.name)[0].value = "";
        return;
      }

      console.log(input);
      var file = input.files[0]
      console.log(file);
      // console.log(reader.result);
      var formData = new FormData();
      formData.append("file", file);
      qid = input.name
      console.log(formData);

      document.getElementById("fileInputLoader_" + qid).style.display = "block";

      displayIdsLoadingIndicator.push("fileInputLoader_" + qid);


      var xhr = new XMLHttpRequest();
      xhr.open("POST", getApiUrl() + '/api/public/form-submission/' + fid + '/question/' + qid + '/uploadfile');
      xhr.setRequestHeader("X-TenantID", bid);
      xhr.onload = function () {
        console.log(xhr)
        if (xhr.status === 200) {
          console.log("File uploaded successfully!");

          // <!-- -------------------------- Logiv for preview -------------------------- -->
          var reader = new FileReader();
          reader.onload = function (e) {
            var preview = document.querySelector(".preview_" + qid);
            if (file.type.startsWith("image/")) {
              preview.innerHTML = "<img src='" + e.target.result + "' />";
            } else if (file.type.startsWith("application/pdf")) {
              preview.innerHTML = "<embed src='" + e.target.result + "' type='application/pdf' />";
            } else if (file.type.startsWith("application/vnd.ms-excel")) {
              preview.innerHTML = "<object data='" + e.target.result + "' type='application/vnd.ms-excel'></object>";
            } else {
              preview.innerHTML = "Preview not available for this file type.";
            }
            document.getElementsByClassName("clearBtn_" + qid)[0].style.display = "block";
            document.getElementById("fileInputLoader_" + qid).style.display = "none";

            // document.getElementById("fileInputLoader").style.display = "none";
            // document.getElementById("clearBtn").style.display = "block";

            var responseJson = JSON.parse(xhr.responseText);
            console.log(responseJson, xhr.responseText)
            if (questionarieDataFromAPI?.patientQuestionAnswers) {
              questionarieDataFromAPI?.patientQuestionAnswers.forEach(question => {
                if (question.questionId === qid) {
                  question.answerText = responseJson.location
                }
              });
            } else {
              questionarieDataFromAPI?.forEach(question => {
                if (question.questionId === qid) {
                  question.answerText = responseJson.location
                }
              });
            }

            console.log(questionarieDataFromAPI)
          }
          reader.readAsDataURL(file);

        } else {
          console.error("Error uploading file.");
          document.getElementById("fileInputLoader_" + qid).style.display = "none";
          document.getElementsByClassName("clearBtn_" + qid)[0].style.display = "block";

          document.querySelector(".preview_" + qid).innerHTML = "<p style='color: red'>An error occurred while uploading the file. Please try again. </p>";
        }
      };
      xhr.send(formData);
    }


    function clearPreview(input) {
      document.getElementsByClassName("fileInput_" + input)[0].value = "";
      document.querySelector(".preview_" + input).innerHTML = "";
      document.getElementsByClassName("clearBtn_" + input)[0].style.display = "none";
    }

    function handleDropdownChange(selectElement) {
      if (selectElement.value === '') {
        selectElement.classList.add('placeholder-color'); // Add the class
      } else {
        selectElement.classList.remove('placeholder-color'); // Remove the class
      }
    }

    function validatePhoneNumber(input) {
      const qid = input.getAttribute('name');
      if (input.value && !phoneNumberMap[qid].isValidNumber()) {
        $('#v_' + qid).css("display", "block");
      } else {
        $("#v_" + qid).css("display", "none");
        input.value = phoneNumberMap[qid].getNumber(intlTelInputUtils.numberFormat.NATIONAL);
      }
    }

  </script>
</body>

</html>